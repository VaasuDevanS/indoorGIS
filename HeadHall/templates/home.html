<html lang="en"> {% load static %}
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="{% static 'HeadHall/css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'HeadHall/css/leaflet.css' %}" />
    <link rel="stylesheet" href="{% static 'HeadHall/css/jquery-ui.css' %}" />
    <link rel="stylesheet" href="{% static 'HeadHall/css/slick.css' %}"/>
    <link rel="stylesheet" href="{% static 'HeadHall/css/metisMenu.min.css' %}">
    <link rel="stylesheet" href="{% static 'HeadHall/css/toggle-switch.css' %}" /> <!-- https://ghinda.net/css-toggle-switch/ -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css">

    <title> indoorGIS: HeadHall </title>
    <link rel="icon" href="{% static 'HeadHall/images/GISIcon.ico' %}">

    <style>
        .leaflet-container {
            background-color:rgba(255,0,0,0.0);
            border: 1px solid black;
        }
        input[type=text] {
            border: none;
            border-bottom: 1px solid purple;
            width: 280px;
            background-color: #F5F5F5;
        }
        img:hover {
            cursor: pointer;
        }
        input[type="reset"] {
            background-image: url( {% static 'HeadHall/images/reset.png' %} );
            background-position: center center;
            background-repeat: no-repeat;
            height: 32px;
            width: 32px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            position: relative;
            top: -3px;
            left: -44px;
        }
        #toReset {
            left: -41px;
        }
        .carouselMap {
            width: 100%;
            height: 53.2%;
        }
        /*.slick-prev:after { content: "<"; color: black; font-size: 30px; }*/
        /*.slick-next:before { content: ">"; color: black; font-size: 30px; }*/
        .categories {
            padding-left: 20px;
        }
        .categories, .categories ul {
            list-style: none;
        }
        .categories li {
            position: relative;
        }
        .categories li a {
            display: block;
            padding-top: 5px;
            padding-bottom: 5px;
            color: #333;
            text-decoration: none;
            outline: 0 none;
        }
        .categories ul:before {
            position: absolute;
            border-left: 1px dotted #333;
            content: "";
            width: 30px;
            top: 25px;
            left: 5px;
            bottom: 17px;
        }
        .categories ul > li:before {
            position: absolute;
            border-top: 1px dotted #333;
            content: "";
            width: 30px;
            top: 13px;
            left: -33px;
        }
        #lsteps, #llift {
            cursor: pointer;
        }
        .leaflet-tooltip.labelstyle {
            background-color: transparent;
            border: transparent;
            box-shadow: none;
        }
    </style>

</head>
<body style="background-color:#F5F5F5">
    <script src="{% static 'HeadHall/js/jquery-3.3.1.js' %}"> </script>
    <script src="{% static 'HeadHall/js/jquery-ui.js' %}"> </script>
    <script src="{% static 'HeadHall/js/bootstrap.min.js' %}"> </script>
    <script src="{% static 'HeadHall/js/leaflet.js' %}"> </script>
    <script src="{% static 'HeadHall/js/slick.min.js' %}"> </script>
    <script src="{% static 'HeadHall/js/metismenu.js' %}"></script>

    <div style="float:left; padding-top:2%; padding-left:2.6%">
        <img id="srchBtn" title="Search" src="{% static 'HeadHall/images/search-icon.png' %}"> &emsp;
        <img id="rteBtn" title="Routing" src="{% static 'HeadHall/images/directions-icon.png' %}"> &emsp;
        <img id="catBtn" title="Categories" src="{% static 'HeadHall/images/categories-icon.png' %}" width=65 height=65> &emsp;
        <img title="Clear" src="{% static 'HeadHall/images/clear.png' %}" onclick="clearFunc()">
        <br><br><br>
        <div id="srch" hidden>
            <input type="text" id="searchBox" /> <input type="reset" id="srchReset" value="" />
            <br><br>
            <button class="btn btn-primary" onclick="search()"> Find </button> &emsp;
            <button id="directions" hidden> Directions </button>
            <br><br>
            <div id="srchResult"> </div>
        </div>
        <div id="rte" hidden>
            From &emsp; <input type="text" id="from" /> <input type="reset" id="fromReset" value="" />
            <br><br>
            To &emsp;&emsp; <input type="text" id="to" /> <input type="reset" id="toReset" value="" />
            <br><br>
            <div style="display:flex; height:3.2%">
                <button class="btn btn-default" id="swap"> Swap </button> &emsp;
                <button class="btn btn-primary" onclick="routeFromTo()"> Show Route </button> &emsp;
                <div id="steps_lift" class="switch-toggle switch-candy switch-candy-blue" style="width:36%">
                    <input id="steps" value="Steps" name="mode" type="radio" checked>
                    <label id="lsteps" for="steps" onclick="">Steps</label>
                    <input id="lift" value="Lift" name="mode" type="radio">
                    <label id="llift" for="lift" onclick="">Lift</label>
                    <a></a>
                </div>
            </div>
        </div>
        <div id="cat" style="overflow-y: auto; height:80%;" hidden>
            <ul class="categories">
                <div id="catContent">  </div>
            </ul>
        </div>
    </div>

    <div class="container" style="padding-left:46px">
        <center> <br><br>
            <div class="carouselMap">
                <div> <div id="ELevel" style="width:87%;height:100%"> </div> </div>
                <div> <div id="DLevel" style="width:90%;height:100%"> </div> </div>
                <div> <div id="CLevel" style="width:87%;height:100%"> </div> </div>
                <div> <div id="BLevel" style="width:88%;height:100%"> </div> </div>
            </div>
            <div class="menu">
                <a href="#">E Level</a> |
                <a href="#">D Level</a> |
                <a href="#">C Level</a> |
                <a href="#">B Level</a>
            </div>
            <a href="#about" data-toggle="modal">About</a> -
            <a href="https://github.com/VaasuDevanS/indoorGIS" target="_blank">Github</a> -
            <a href="#features" data-toggle="modal">Features</a>
        </center>
    </div> <br>

	<div id="about" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title">indoorGIS</h4>
				</div>
				<div class="modal-body">
				    <img src="{% static 'HeadHall/images/UNBLogo.jpg' %}" width=200 height=100>
				    <img src="{% static 'HeadHall/images/GGELogo.gif' %}" width=100 height=100> <br> <br>
					<b> Directed Research Project - 2019 </b><br>
					WebApp for finding Faculties, Facilities, Routing and more <br>
					Supervisor: <a href="https://www.unb.ca/faculty-staff/directory/engineering-geomatics/jabari-shabnam.html" target="_blank">Shabnam Jabari</a><br>
					Developer: <a href="https://vaasudevans.github.io/" target="_blank">Vaasudevan Srinivasan</a> <br> <br>
					<a href="https://www.unb.ca/" target="_blank">UNB Homepage</a> |
					<a href="https://www.unb.ca/fredericton/engineering/depts/gge/index.html" target="_blank">GGE Homepage</a>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div id="features" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title">Search / Route for</h4>
				</div>
				<div class="modal-body">
				    <div id="fields" style="overflow: auto; height: 60%"> </div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>


<script>

$(function() {

    $(".carouselMap").slick({
        accessibility: false,
        draggable: false,
        arrows: false,
        touchMove: false
    });
    $(".menu a").click(function(e) {
        e.preventDefault();
        slideIndex = $(this).index();
        $( '.carouselMap' ).slickGoTo( parseInt(slideIndex) );
    });

    // http://output.jsbin.com/uloli3/63
    $("#srchReset").click(function() {
        $("#searchBox").val("").focus();
        resetStyle();
    })
    $("#fromReset").click(function() {
        markerArray = [];
        EblkLyr.setStyle(styleFunc());
        $("#from").val("").focus();
        eLevel.removeLayer(markerGroup);
    })
    $("#toReset").click(function() {
        markerArray = [];
        EblkLyr.setStyle(styleFunc());
        $("#to").val("").focus()
        eLevel.removeLayer(markerGroup);
    })

    function hideAll () {
        $("#rte").hide();
        $("#srch").hide();
        $("#cat").hide();
    }
    $("#srchBtn").click(function() {
        hideAll();
        $("#srch").show();
        $("#searchBox").focus();
    })
    $("#directions").click(function() {
        hideAll();
        $("#rte").show();
        $("#from").focus();
        $("#to").val($("#searchBox").val())
    })
    $("#rteBtn").click(function() {
        hideAll();
        $("#rte").show();
        $("#from").focus();
    })
    $("#swap").click(function() {
        temp = $("#to").val();
        $("#to").val($("#from").val());
        $("#from").val(temp);
    })
    $("#catBtn").click(function() {
        hideAll();
        $("#cat").show();
    })

    $.ajax({url: "{% url 'loadFields' %}",
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            type: "POST",
            success: function(flds) {
                $("input[type=text]").autocomplete({
                    source: eval(flds),
                    minLength:2
                });
                tmpFlds = [];
                for (i in eval(flds)) {
                    tmpFlds.push(eval(flds)[i].label+"<br>")
                }
                $("#fields").html(tmpFlds)
            }
    });

    $.ajax({url: "{% url 'loadCategories' %}",
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            type: "POST",
            success: function(catContent) {
                $("#catContent").html(catContent);
                $('.categories').metisMenu({ toggle: true });
            }
    });

    // Leaflet function
    $.ajax({url: "{% url 'loadJSON' %}",
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            type: "POST",
            success: function(Blocks) {
                allBlks = eval(Blocks)
                // E-Level
                EblkLyr = L.geoJSON(JSON.parse(allBlks[0]), {
                                    style: styleFunc,
                                    onEachFeature: onEachFeatureFunc
                }).addTo(eLevel);
                // D-Level
                DblkLyr = L.geoJSON(JSON.parse(allBlks[1]), {
                                    style: styleFunc,
                                    onEachFeature: onEachFeatureFunc
                }).addTo(dLevel);
                // C-Level
                CblkLyr = L.geoJSON(JSON.parse(allBlks[2]), {
                                    style: styleFunc,
                                    onEachFeature: onEachFeatureFunc
                }).addTo(cLevel);
                // B-Level
                BblkLyr = L.geoJSON(JSON.parse(allBlks[3]), {
                                    style: styleFunc,
                                    onEachFeature: onEachFeatureFunc
                }).addTo(bLevel);
            }
    });

});

function search() {
    $("#directions").show();
    $.ajax({url: "{% url 'searchBox' %}",
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            type: "POST",
            data: {keyword: $("#searchBox").val()},
            success: searchFunc
    });
}

function searchFunc(Oid_lvl) {
    Oid = eval(Oid_lvl)[0];
    lvl = eval(Oid_lvl)[1];
    blkLyr = [EblkLyr, DblkLyr, CblkLyr, BblkLyr][lvl];
    level = [eLevel, dLevel, cLevel, bLevel][lvl];
    for (i in blkLyr._layers) {
        f = blkLyr._layers[i].feature.properties;
        if (f.OBJECTID == Oid) {
            cntnt = "";
            if (f.PersonName != null) {
                cntnt += "<i class='fas fa-user-alt'></i> " + f.PersonName + "<br>" }
            if (f.PlaceName != null) {
                cntnt +=  "<i class='fas fa-map-marker-alt'></i> " + f.PlaceName + "<br>" }
            if (f.Contact != null) {
                cntnt += "<i class='fas fa-mobile'></i> " + f.Contact + "<br>" }
            if (f.Email != null) {
                cntnt += "<i class='fas fa-envelope'></i> " + f.Email + "<br>" }
            if (f.Details != null) {
                cntnt += "<b>Other Info: </b><br>" +
                          f.Details.replace(/,/g, "<br>") }
            if ($("#searchBox").val() != "") {
                $("#srchResult").html(cntnt); }
            EblkLyr.setStyle(styleFunc());
            DblkLyr.setStyle(styleFunc());
            CblkLyr.setStyle(styleFunc());
            BblkLyr.setStyle(styleFunc());
            blkLyr._layers[i].setStyle(selectStyle());
            blkLyr._layers[i].openPopup();
            level.fitBounds(blkLyr._layers[i]._bounds.pad(-2));
            break;
        }
    }
    $( '.carouselMap' ).slickGoTo( lvl );
}


function routeFromTo() {
    $.ajax({url: "{% url 'from_to_route' %}",
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            type: "POST",
            data: {from: $("#from").val(),
                   to: $("#to").val(),
                   mode: $("input[name='mode']:checked").val()
            },
            success: routeFunc
    });
}


// Generate route (necessary for routeFromTo function)
function routeFunc(i) {

    extnt_pts = eval(i);

    // Create markers and zoom to highlighted blocks extent
    bounds = [[extnt_pts[0][3], extnt_pts[0][2]],
              [extnt_pts[0][1], extnt_pts[0][0]]];

    for (pt of extnt_pts[1]) {
        markerArray.push(L.marker(pt, {icon: footpath}));
        bounds.push(pt);
    }

    level = [eLevel, dLevel, cLevel, bLevel][extnt_pts[3]]
    lyr = [EblkLyr, DblkLyr, CblkLyr, BblkLyr][extnt_pts[3]]

    // Highlight Blocks
    for (i in lyr._layers) {
        blk = lyr._layers[i];
        if ($.inArray(blk.feature.properties.OBJECTID, extnt_pts[2]) != -1) {
            blk.setStyle(selectStyle())
        }
    }

    markerGroup = L.featureGroup(markerArray).addTo(level);
    level.fitBounds(bounds);

    $( '.carouselMap' ).slickGoTo( extnt_pts[3] );
}

// Reset page
function clearFunc() {
    markerArray=[];
    $("#searchBox").val(''); $("#from").val(''); $("#to").val('');
    $("#searchBox").focus(); $("#from").focus();
    resetStyle();
    eLevel.removeLayer(markerGroup);
    dLevel.removeLayer(markerGroup);
    cLevel.removeLayer(markerGroup);
    bLevel.removeLayer(markerGroup);
}

function resetStyle() {
    $("#directions").hide();
    $("#srchResult").html("");
    EblkLyr.setStyle(styleFunc());
    DblkLyr.setStyle(styleFunc());
    CblkLyr.setStyle(styleFunc());
    BblkLyr.setStyle(styleFunc());
    eLevel.setZoom(2.45);
    dLevel.setZoom(2.45);
    cLevel.setZoom(2.45);
    bLevel.setZoom(2.45);
    eLevel.closePopup();
    dLevel.closePopup();
    cLevel.closePopup();
    bLevel.closePopup();
}


// ----------------------------- Leaflet --------------------------------------

let markerArray = []; // Global

function onEachFeatureFunc(feature, layer) {

    // Tooltip (Labelling)
    layer.bindTooltip(feature.properties.PlaceNode.toString(),
                      {direction: "center",
                       permanent: true,
                       className: 'labelstyle'
                      }).openTooltip();
    $('.leaflet-tooltip').css("font-size", 10);

    // Popup Content
    var content = "";
    if (feature.properties.PersonName != null) {
        content += "<i class='fas fa-user-alt'></i> " + feature.properties.PersonName + "<br>"; }
    if (feature.properties.PlaceName != null) {
        content += "<i class='fas fa-map-marker-alt'></i> " + feature.properties.PlaceName; }
    layer.bindPopup(content);
    layer.on('mouseover', function(f) { f.target.setStyle(selectStyle()) });
    layer.on('mouseout', function(f) { f.target.setStyle(styleFunc()); layer.closePopup() });
    // layer.off('click', this.openPopup);
}


// Icon for the route
var footpath = L.icon({
    iconUrl: "{% static 'HeadHall/images/walking.png' %}",
    iconSize: [20,20]
});

function styleFunc() { return {weight:0.2, fillOpacity:0, opacity:0.5, color:"red"} }
function selectStyle() { return {color:"#00FFFF", fillOpacity:0.5} }

levelConfig = { minZoom: 2.45,
                maxZoom: 5,
                crs: L.CRS.Simple,
                maxBounds: [[0, 0], [90, 180]],
                maxBoundsViscosity: 1.0,
                attributionControl: false
}
var bounds = [[0, 0], [90, 180]];

// E-Level
url = "{% static 'HeadHall/baseimages/E_Level.png' %}";
var eLevel = L.map('ELevel', levelConfig);
L.imageOverlay(url, bounds).addTo(eLevel);
eLevel.fitBounds(bounds);

// D-Level
url = "{% static 'HeadHall/baseimages/D_Level.jpg' %}";
var dLevel = L.map('DLevel', levelConfig);
L.imageOverlay(url, bounds).addTo(dLevel);
dLevel.fitBounds(bounds);

// C-Level
url = "{% static 'HeadHall/baseimages/C_Level.jpg' %}";
var cLevel = L.map('CLevel', levelConfig);
L.imageOverlay(url, bounds).addTo(cLevel);
cLevel.fitBounds(bounds);

// B-Level
url = "{% static 'HeadHall/baseimages/B_Level.jpg' %}";
var bLevel = L.map('BLevel', levelConfig);
L.imageOverlay(url, bounds).addTo(bLevel);
bLevel.fitBounds(bounds);

</script>

</body>
</html>